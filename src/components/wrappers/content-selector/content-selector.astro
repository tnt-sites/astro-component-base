---
import Heading from "@components/typography/heading/heading.astro";
import RenderBlock from "@components/utils/renderBlock.astro";

const { items, navigationPosition = "start", class: className, label, ...restProps } = Astro.props;

const htmlAttributes = Object.fromEntries(
  Object.entries(restProps).filter(([key]) => key !== "_bookshop_name")
);

const slugifyLabel = (label: string) => {
  return label
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
};

if (!htmlAttributes.id && label) {
  htmlAttributes.id = slugifyLabel(label);
}

const uniqueId = crypto.randomUUID();
---

<section
  class:list={["content-selector", `nav-${navigationPosition}`, className]}
  data-uid={uniqueId}
  {...htmlAttributes}
>
  {
    items?.map((item: any, index: number) => (
      <input
        type="radio"
        name={`tabs-${uniqueId}`}
        id={`tab-${uniqueId}-${index}`}
        class="input"
        hidden
        checked={index === 0}
        autocomplete="off"
      />
    ))
  }

  <div class="tabs" role="tablist">
    {
      items?.map((item: any, index: number) => (
        <label
          class="tab"
          id={`tablabel-${uniqueId}-${index}`}
          for={`tab-${uniqueId}-${index}`}
          role="tab"
          aria-controls={`panel-${uniqueId}-${index}`}
          tabindex="0"
          aria-selected={index === 0}
        >
          <Heading
            text={item.title}
            level="h3"
            size="h3"
            alignX={navigationPosition === "top" ? "center" : "start"}
            class="tab-heading"
          />
        </label>
      ))
    }
  </div>

  <div class="panels">
    {
      items?.map((item: any, index: number) => (
        <div
          class="panel"
          id={`panel-${uniqueId}-${index}`}
          role="tabpanel"
          aria-labelledby={`tablabel-${uniqueId}-${index}`}
          aria-hidden={index !== 0}
        >
          <RenderBlock contentBlocks={item.contentBlocks} />
        </div>
      ))
    }
  </div>

  <script>
    function updateContentSelectorAria(el: HTMLElement) {
      const inputs = Array.from(el.querySelectorAll<HTMLInputElement>('input.input[type="radio"]'));
      const tabs = Array.from(el.querySelectorAll<HTMLElement>('[role="tab"]'));
      const panels = Array.from(el.querySelectorAll<HTMLElement>('[role="tabpanel"]'));
      const checked = el.querySelector<HTMLInputElement>('input.input[type="radio"]:checked');
      const checkedIndex = checked ? inputs.indexOf(checked) : 0;
      tabs.forEach((tab: HTMLElement, i: number) =>
        tab.setAttribute("aria-selected", i === checkedIndex ? "true" : "false")
      );
      panels.forEach((panel: HTMLElement, i: number) =>
        panel.setAttribute("aria-hidden", i !== checkedIndex ? "true" : "false")
      );
    }

    function setupContentSelectors() {
      document.querySelectorAll("section.content-selector").forEach((node) => {
        if (!(node instanceof HTMLElement)) return;
        const el: HTMLElement = node;
        const inputs = el.querySelectorAll<HTMLInputElement>('input.input[type="radio"]');
        inputs.forEach((input) => {
          input.addEventListener("change", () => updateContentSelectorAria(el));
        });
        updateContentSelectorAria(el);
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", setupContentSelectors);
    } else {
      setupContentSelectors();
    }
  </script>
</section>
