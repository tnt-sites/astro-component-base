---
import Component from "@components/utils/renderBlock.astro";

const {
  firstColumnContentBlocks = [],
  secondColumnContentBlocks = [],
  distributionMode = "half",
  verticalAlignment = "top",
  reverse = false,
  fixedWidth,
  minSplitWidth = 0,
  class: className,
  label,
  ...rest
} = Astro.props;

const htmlAttributes = Object.fromEntries(
  Object.entries(rest).filter(([key]) => key !== "_bookshop_name")
);

const slugifyLabel = (label: string) => {
  return label
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
};

if (!htmlAttributes.id && label) {
  htmlAttributes.id = slugifyLabel(label);
}

// Get content blocks based on reverse setting
const firstContentBlocks = reverse ? secondColumnContentBlocks : firstColumnContentBlocks;
const secondContentBlocks = reverse ? firstColumnContentBlocks : secondColumnContentBlocks;

const getReversedDistributionMode = (mode: string) => {
  const reverseMap = {
    "third-two-thirds": "two-thirds-third",
    "two-thirds-third": "third-two-thirds",
    "quarter-three-quarters": "three-quarters-quarter",
    "three-quarters-quarter": "quarter-three-quarters",
    "fixed-flexible": "flexible-fixed",
    "flexible-fixed": "fixed-flexible",
    half: "half",
  };

  return reverseMap[mode as keyof typeof reverseMap] || mode;
};

const finalDistributionMode = reverse
  ? getReversedDistributionMode(distributionMode)
  : distributionMode;

// Generate unique ID for container query targeting
const splitId = `split-${crypto.randomUUID()}`;
---

<section
  class:list={["split", `align-${verticalAlignment}`, finalDistributionMode, className]}
  data-split-id={splitId}
  style={fixedWidth ? `--split-fixed-width: ${fixedWidth}px;` : ""}
  {...htmlAttributes}
>
  <div class="pane first">
    <Component contentBlocks={firstContentBlocks} />
    {reverse ? <slot name="second" /> : <slot name="first" />}
  </div>
  <div class="pane second">
    <Component contentBlocks={secondContentBlocks} />
    {reverse ? <slot name="first" /> : <slot name="second" />}
  </div>
</section>

{
  minSplitWidth > 0 && (
    <style
      is:inline
      set:html={`
    @container (max-width: ${minSplitWidth}px) {
      .split[data-split-id="${splitId}"] {
        grid-template-columns: var(--split-columns-mobile);
      }
    }
  `}
    />
  )
}
