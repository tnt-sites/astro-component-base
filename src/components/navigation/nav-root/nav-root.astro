---
import Button from "@components/elements/button/button.astro";
import RenderBlock from "@components/utils/renderBlock.astro";

const { variant = "sidebar", navBlocks = [], class: className } = Astro.props;

const navId = `nav-${crypto.randomUUID()}`;
---

{
  variant === "mobile" && (
    <>
      <input type="checkbox" id={`nav-toggle-${navId}`} class="nav-toggle" autocomplete="off" />
      <label
        for={`nav-toggle-${navId}`}
        class:list={["nav-hamburger", className]}
        aria-label="Toggle navigation menu"
      >
        <Button
          variant="tertiary"
          size="none"
          element="span"
          iconName="bars-3"
          hideText="true"
          class="mobile-nav-button"
        />
      </label>
    </>
  )
}

<nav
  class:list={["nav-root", variant, className]}
  id={navId}
  aria-hidden={variant === "mobile" ? "true" : "false"}
>
  {
    variant === "mobile" && (
      <div class="nav-header-bar">
        <div class="nav-header-bar-logo">
          <slot name="logo" />
        </div>
        <Button
          for={`nav-toggle-${navId}`}
          aria-label="Close navigation menu"
          tabindex="0"
          variant="tertiary"
          size="none"
          element="label"
          iconName="x-mark"
          hideText="true"
          class="mobile-nav-close mobile-nav-button"
        />
      </div>
    )
  }
  {
    variant === "mobile" ? (
      <div class="nav-content">
        <slot />
        <RenderBlock contentBlocks={navBlocks} />
      </div>
    ) : (
      <>
        <slot />
        <RenderBlock contentBlocks={navBlocks} />
      </>
    )
  }
</nav>

<script>
  function getOrCreateOverlaysContainer() {
    let overlaysContainer = document.getElementById("overlays-container");
    if (!overlaysContainer) {
      overlaysContainer = document.createElement("div");
      overlaysContainer.id = "overlays-container";
      overlaysContainer.className = "overlays-container";
      document.body.appendChild(overlaysContainer);
    }
    return overlaysContainer;
  }

  // Initialize all navigation components
  function initializeNav() {
    const allNavs = document.querySelectorAll(".nav-root");

    allNavs.forEach((nav) => {
      const navElement = nav;
      const navId = navElement.id;
      const isMobile = navElement.classList.contains("mobile");

      navElement.setAttribute("data-nav-initialized", "true");

      // Get mobile nav elements (only needed for mobile navs)
      const toggle = document.getElementById(`nav-toggle-${navId}`);
      const hamburger = document.querySelector(`label[for="nav-toggle-${navId}"]`);

      if (isMobile) {
        if (!toggle || !hamburger) return;

        // Move the nav to the overlays container
        const overlaysContainer = getOrCreateOverlaysContainer();
        navElement.className = "nav-root mobile nav-root-overlay";
        navElement.setAttribute("data-nav-id", navId);
        overlaysContainer.appendChild(navElement);
      }

      // Always dispatch nav-init event for child components
      const initEvent = new CustomEvent("nav-init", {
        detail: { navElement },
      });
      navElement.dispatchEvent(initEvent);

      if (isMobile) {
        function handleNavToggle(isOpen) {
          if (isOpen) {
            navElement.classList.add("open");
            navElement.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";

            const closeButton = navElement.querySelector(".mobile-nav-close");
            if (closeButton) {
              closeButton.focus();
            }
          } else {
            navElement.classList.remove("open");
            navElement.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";

            // Return focus to hamburger when closing
            if (hamburger) hamburger.focus();
          }
        }

        // Handle hamburger click
        hamburger.addEventListener("click", (e) => {
          e.preventDefault();
          const isCurrentlyOpen = navElement.classList.contains("open");
          handleNavToggle(!isCurrentlyOpen);
        });

        // Handle close button click and keyboard
        const closeButton = navElement.querySelector(".mobile-nav-close");
        if (closeButton) {
          closeButton.addEventListener("click", (e) => {
            e.preventDefault();
            handleNavToggle(false);
          });

          closeButton.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              handleNavToggle(false);
            }
          });
        }

        // Handle toggle checkbox changes (fallback)
        toggle.addEventListener("change", (e) => {
          handleNavToggle(e.target.checked);
        });
      }
    });
  }

  initializeNav();

  // Close navs with Escape key
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      const openNavs = document.querySelectorAll(".nav-root-overlay.open");
      if (openNavs.length > 0) {
        openNavs.forEach((navElement) => {
          navElement.classList.remove("open");
          const navId = navElement.getAttribute("data-nav-id");
          if (navId) {
            const originalNav = document.getElementById(navId);
            if (originalNav) {
              originalNav.setAttribute("aria-hidden", "true");
            }
          }
        });
        document.body.style.overflow = "";
      }
    }
  });
</script>
