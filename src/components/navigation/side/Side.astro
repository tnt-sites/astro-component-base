---
import Icon from "@core-elements/icon/Icon.astro";

const { navData = [], class: className, _component, ...htmlAttributes } = Astro.props;

// Generate a unique ID for this navigation instance to scope radio buttons
const navInstanceId = crypto.randomUUID();

// Helper function to check if item is current page
function isCurrentPage(item) {
  return item.path && Astro.url.pathname === item.path;
}

// Helper function to check if any child is current page (recursive)
function hasCurrentChild(item) {
  if (isCurrentPage(item)) return true;
  if (item.children && item.children.length > 0) {
    return item.children.some((child) => hasCurrentChild(child));
  }
  return false;
}
---

<nav class:list={["side", className]} {...htmlAttributes}>
  <ul class="side-list">
    {
      navData.map((item) => {
        const hasChildren = item.children && item.children.length > 0;
        const dropdownId = `dropdown-toggle-${crypto.randomUUID()}`;
        const contentId = `dropdown-content-${crypto.randomUUID()}`;
        const parentGroupId = `parent-${crypto.randomUUID()}`;
        const isCurrent = isCurrentPage(item);
        const hasCurrent = hasCurrentChild(item);

        if (hasChildren) {
          return (
            <li class="nav-item has-children">
              <input
                type="radio"
                name={`side-nav-top-${navInstanceId}`}
                id={dropdownId}
                class="nav-item-toggle"
                aria-expanded={hasCurrent.toString()}
                aria-controls={contentId}
                autocomplete="off"
                checked={hasCurrent}
              />
              <label
                for={dropdownId}
                class="nav-item-trigger"
                role="button"
                aria-controls={contentId}
                tabindex="0"
                aria-current={isCurrent ? "page" : undefined}
              >
                {item.name}
                <span class="nav-item-icon">
                  <Icon name="chevron-right" size="none" aria-hidden="true" />
                </span>
              </label>
              <div
                id={contentId}
                class:list={["nav-item-content", hasCurrent && "nav-item-content-initial"]}
                role="region"
                aria-label={`${item.name} submenu`}
                aria-hidden={(!hasCurrent).toString()}
              >
                <ul class="nav-list">
                  {item.children.map((child) => {
                    const childHasChildren = child.children && child.children.length > 0;
                    const childDropdownId = `dropdown-toggle-${crypto.randomUUID()}`;
                    const childContentId = `dropdown-content-${crypto.randomUUID()}`;
                    const childIsCurrent = isCurrentPage(child);
                    const childHasCurrent = hasCurrentChild(child);

                    if (childHasChildren) {
                      return (
                        <li class="nav-item has-children">
                          <input
                            type="radio"
                            name={`side-nav-${parentGroupId}`}
                            id={childDropdownId}
                            class="nav-item-toggle"
                            aria-expanded={childHasCurrent.toString()}
                            aria-controls={childContentId}
                            autocomplete="off"
                            checked={childHasCurrent}
                          />
                          <label
                            for={childDropdownId}
                            class="nav-item-trigger"
                            role="button"
                            aria-controls={childContentId}
                            tabindex="0"
                            aria-current={childIsCurrent ? "page" : undefined}
                          >
                            {child.name}
                            <span class="nav-item-icon">
                              <Icon name="chevron-right" size="none" aria-hidden="true" />
                            </span>
                          </label>
                          <div
                            id={childContentId}
                            class:list={[
                              "nav-item-content",
                              childHasCurrent && "nav-item-content-initial",
                            ]}
                            role="region"
                            aria-label={`${child.name} submenu`}
                            aria-hidden={(!childHasCurrent).toString()}
                          >
                            <ul class="nav-list">
                              {child.children && child.children.length > 0
                                ? child.children.map((grandChild) => (
                                    <li class="nav-item">
                                      <a
                                        href={grandChild.path}
                                        aria-current={
                                          isCurrentPage(grandChild) ? "page" : undefined
                                        }
                                      >
                                        {grandChild.name}
                                      </a>
                                    </li>
                                  ))
                                : null}
                            </ul>
                          </div>
                        </li>
                      );
                    } else {
                      return (
                        <li class="nav-item">
                          <a
                            href={child.path || "#"}
                            aria-current={childIsCurrent ? "page" : undefined}
                          >
                            {child.name}
                          </a>
                        </li>
                      );
                    }
                  })}
                </ul>
              </div>
            </li>
          );
        } else {
          return (
            <li class="nav-item">
              <a href={item.path || "#"} aria-current={isCurrent ? "page" : undefined}>
                {item.name}
              </a>
            </li>
          );
        }
      })
    }
  </ul>
</nav>

<script>
  function setupSideNavigation() {
    const sideNavs = document.querySelectorAll(".side");
    if (!sideNavs.length) return;

    sideNavs.forEach((sideNav) => {
      // Handle radio button changes
      sideNav.querySelectorAll(".nav-item-toggle").forEach((toggle) => {
        toggle.addEventListener("change", (e) => {
          const target = e.target;
          const content = document.getElementById(target.getAttribute("aria-controls") || "");
          const trigger = sideNav.querySelector(`label[for="${target.id}"]`);

          if (content && trigger) {
            const isOpen = target.checked;

            // Update ARIA attributes
            target.setAttribute("aria-expanded", isOpen.toString());
            content.setAttribute("aria-hidden", (!isOpen).toString());

            // Update trigger ARIA attributes
            trigger.setAttribute("aria-expanded", isOpen.toString());
          }
        });
      });

      // Handle label interactions for toggling dropdowns
      sideNav.querySelectorAll(".nav-item-trigger").forEach((trigger) => {
        // Click handler
        trigger.addEventListener("click", (e) => {
          const label = e.currentTarget;
          const toggleId = label.getAttribute("for");
          const toggle = document.getElementById(toggleId || "");

          if (toggle && toggle.checked) {
            // If the item is already open, close it
            e.preventDefault();
            toggle.checked = false;
            toggle.dispatchEvent(new Event("change"));
          }
        });

        // Keyboard handler
        trigger.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            e.stopPropagation();
            const label = e.currentTarget;
            const toggleId = label.getAttribute("for");
            const toggle = document.getElementById(toggleId || "");

            if (toggle) {
              if (toggle.checked) {
                toggle.checked = false;
              } else {
                toggle.checked = true;
              }
              toggle.dispatchEvent(new Event("change"));
            }
          }
        });
      });
    });
  }
  setupSideNavigation();

  setTimeout(() => {
    const initialNavItems = document.querySelectorAll(".nav-item-content-initial");
    initialNavItems.forEach((item) => {
      item.classList.remove("nav-item-content-initial");
    });
  }, 1000);
</script>

<style lang="pcss" is:global>
  @layer components {
    /* Sidebar Navigation Styles */
    .side {
      margin-top: var(--spacing-lg);

      .side-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .nav-item {
        list-style: none;
        position: relative;

        a,
        .nav-item-trigger {
          border-radius: var(--radius-xs);
          color: inherit;
          display: flex;
          font-weight: var(--font-weight-semibold);
          padding: var(--spacing-sm) var(--spacing-md);
          text-decoration: none;
          transition: background-color var(--animation-normal) ease;

          &:hover,
          &:focus-visible {
            background-color: var(--color-state-hover);
            color: var(--color-text-strong);

            .nav-item-icon {
              color: var(--color-text-strong);
            }
          }

          &[aria-current="page"] {
            text-decoration: underline dotted;
            text-decoration-color: var(--color-text-muted);
            text-underline-offset: 3px;
          }
        }
      }

      .nav-item-toggle {
        display: none;
      }

      .nav-item-content {
        display: none;
      }

      .nav-item-toggle:checked ~ .nav-item-content {
        animation: grow-out var(--animation-normal) ease-out;
        display: block;
      }

      .nav-item-toggle:checked ~ .nav-item-content-initial {
        animation-duration: 1ms;
        display: block;
      }

      .nav-item-trigger {
        align-items: center;
        cursor: pointer;
        flex-direction: row;
        justify-content: space-between;
        user-select: none;
        width: 100%;
      }

      .nav-item-icon {
        color: var(--color-text-muted);
        display: inline-block;
        transition: transform var(--animation-normal) ease;
        transform-origin: 50% 60%;
      }

      .nav-item-toggle:checked ~ .nav-item-trigger .nav-item-icon {
        transform: rotate(90deg);
      }

      .nav-list {
        list-style: none;
        margin: 0;
        padding: 0;

        .nav-item a,
        .nav-item .nav-item-trigger {
          font-weight: var(--font-weight-normal);
          padding-inline: var(--spacing-xl);
        }

        .nav-list .nav-item a,
        .nav-list .nav-item .nav-item-trigger {
          padding-inline-start: var(--spacing-2xl);
        }
      }
    }
  }
</style>
