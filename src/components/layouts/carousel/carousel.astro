---
import clsx from "clsx";
import Button from "../../elements/button/button.astro";
import Component from "../../utils/renderBlock.astro";
import "./carousel.pcss";

const {
  slides = [],
  showArrows = true,
  showIndicators = true,
  autoPlay = false,
  autoScroll = false,
  class: className,
  ...rest
} = Astro.props;

const htmlAttributes = Object.fromEntries(
  Object.entries(rest).filter(([key]) => !key.startsWith("_"))
);

const carouselClasses = clsx("carousel", className);
---

<section
  class:list={carouselClasses}
  data-show-arrows={showArrows}
  data-show-indicators={showIndicators}
  data-auto-play={autoPlay}
  data-auto-scroll={autoScroll}
  {...htmlAttributes}
>
  <div class="viewport">
    <div class="track">
      {
        slides.map((slide: any, index: number) => (
          <div class="slide" role="group" aria-label={`Slide ${index + 1} of ${slides.length}`}>
            <Component contentBlocks={slide.content_blocks} />
          </div>
        ))
      }
    </div>
  </div>

  <div class="controls">
    <Button
      iconName="arrow-left"
      size="lg"
      variant="tertiary"
      hideText={true}
      aria-label="Previous slide"
      class="prev"
    />

    <Button
      iconName="arrow-right"
      size="lg"
      variant="tertiary"
      hideText={true}
      aria-label="Next slide"
      class="next"
    />
  </div>

  <div class="indicators"></div>
</section>

<script>
  import EmblaCarousel from "embla-carousel";
  import AutoScroll from "embla-carousel-auto-scroll";
  import Autoplay from "embla-carousel-autoplay";

  export default function setupCarousels() {
    const carousels = document.querySelectorAll(".carousel");

    carousels.forEach((carousel) => {
      // Check if this carousel has already been initialized
      if (carousel.hasAttribute("data-embla-initialized")) {
        return;
      }

      const viewport = carousel.querySelector(".viewport") as HTMLElement;
      const track = viewport?.querySelector(".track") as HTMLElement;
      const slides = track?.querySelectorAll(".slide") as NodeListOf<HTMLElement>;
      const prevButton = carousel.querySelector(".prev") as HTMLButtonElement;
      const nextButton = carousel.querySelector(".next") as HTMLButtonElement;
      const indicatorsContainer = carousel.querySelector(".indicators") as HTMLElement;

      if (!viewport || !track || !slides.length) {
        console.warn("Carousel: Missing required elements");
        return;
      }

      const options: any = {
        align: "start",
        containScroll: "trimSnaps",
      };

      const plugins: any[] = [];

      // Add auto-scroll plugin if enabled
      if (carousel.getAttribute("data-auto-scroll") === "true") {
        plugins.push(AutoScroll());
      }

      // Add autoplay plugin if enabled
      if (carousel.getAttribute("data-auto-play") === "true") {
        plugins.push(Autoplay({ delay: 4000, stopOnInteraction: false }));
      }

      const embla = EmblaCarousel(viewport, options, plugins);

      // Setup navigation buttons
      if (prevButton && nextButton) {
        prevButton.addEventListener("click", () => embla.scrollPrev());
        nextButton.addEventListener("click", () => embla.scrollNext());
      }

      // Setup indicators
      if (indicatorsContainer && slides.length > 1) {
        const indicators = slides.map((_, index) => {
          const button = document.createElement("button");
          button.className = "indicator";
          button.setAttribute("aria-label", `Go to slide ${index + 1}`);
          button.addEventListener("click", () => embla.scrollTo(index));
          return button;
        });

        indicators.forEach((indicator) => indicatorsContainer.appendChild(indicator));

        // Update indicators on scroll
        embla.on("select", () => {
          const selectedIndex = embla.selectedScrollSnap();
          indicators.forEach((indicator, index) => {
            indicator.setAttribute("data-selected", index === selectedIndex ? "true" : "false");
          });
        });

        // Set initial state
        indicators[embla.selectedScrollSnap()]?.setAttribute("data-selected", "true");
      }

      // Mark as initialized
      carousel.setAttribute("data-embla-initialized", "true");
    });
  }

  // Initialize carousels when the page loads
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupCarousels);
  } else {
    setupCarousels();
  }

  // Re-initialize carousels when new content is loaded (for SPA-like behavior)
  document.addEventListener("astro:page-load", setupCarousels);
</script>
