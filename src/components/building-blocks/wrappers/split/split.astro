---
import Component from "@components/utils/renderBlock.astro";

const {
  firstColumnContentBlocks = [],
  secondColumnContentBlocks = [],
  distributionMode = "half",
  verticalAlignment = "top",
  reverse = false,
  fixedWidth,
  minSplitWidth = 700,
  class: className,
  label,
  ...rest
} = Astro.props;

const htmlAttributes = Object.fromEntries(
  Object.entries(rest).filter(([key]) => key !== "_component")
);

const slugifyLabel = (label: string) => {
  return label
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
};

if (!htmlAttributes.id && label) {
  htmlAttributes.id = slugifyLabel(label);
}

// Get content blocks and prop names based on reverse setting
const firstSplitBlocks = reverse ? secondColumnContentBlocks : firstColumnContentBlocks;
const secondSplitBlocks = reverse ? firstColumnContentBlocks : secondColumnContentBlocks;
const firstPropName = reverse ? "secondColumnContentBlocks" : "firstColumnContentBlocks";
const secondPropName = reverse ? "firstColumnContentBlocks" : "secondColumnContentBlocks";

const getReversedDistributionMode = (mode: string) => {
  const reverseMap = {
    "third-two-thirds": "two-thirds-third",
    "two-thirds-third": "third-two-thirds",
    "quarter-three-quarters": "three-quarters-quarter",
    "three-quarters-quarter": "quarter-three-quarters",
    "fixed-flexible": "flexible-fixed",
    "flexible-fixed": "fixed-flexible",
    half: "half",
  };

  return reverseMap[mode as keyof typeof reverseMap] || mode;
};

const finalDistributionMode = reverse
  ? getReversedDistributionMode(distributionMode)
  : distributionMode;

// Generate unique ID for container query targeting
const splitId = `split-${crypto.randomUUID()}`;
---

<section
  class:list={["split", `align-${verticalAlignment}`, finalDistributionMode, className]}
  data-split-id={splitId}
  style={fixedWidth ? `--split-fixed-width: ${fixedWidth}px;` : ""}
  {...htmlAttributes}
>
  <div class="pane first">
    {
      firstSplitBlocks && firstSplitBlocks.length > 0 ? (
        <Component contentBlocks={firstSplitBlocks} propName={firstPropName} />
      ) : reverse ? (
        <slot name="second" />
      ) : (
        <slot name="first" />
      )
    }
  </div>
  <div class="pane second">
    {
      secondSplitBlocks && secondSplitBlocks.length > 0 ? (
        <Component contentBlocks={secondSplitBlocks} propName={secondPropName} />
      ) : reverse ? (
        <slot name="first" />
      ) : (
        <slot name="second" />
      )
    }
  </div>
</section>

{
  minSplitWidth > 0 && (
    <style
      is:inline
      set:html={`
    @container (max-width: ${minSplitWidth}px) {
      .split[data-split-id="${splitId}"] {
        grid-template-columns: var(--split-columns-mobile);
      }
    }
  `}
    />
  )
}

<style lang="pcss">
  :where(:has(> .split):not(:is(editable-array-item, editable-array))) {
    container-type: inline-size;
  }

  :where(:has(> editable-array > editable-array-item > .split)) {
    container-type: inline-size;
  }

  .split {
    --gap-size: var(--spacing-lg);
    --split-columns-mobile: 1fr;
    --split-columns-desktop: 1fr 1fr;
    --split-fixed-width: auto;

    display: grid;
    gap: var(--gap-size);
    grid-template-columns: var(--split-columns-desktop);
    margin-top: var(--spacing-lg);

    &.align-top {
      align-items: start;
    }

    &.align-center {
      align-items: center;
    }

    &.align-bottom {
      align-items: end;
    }

    &.align-stretch {
      align-items: stretch;

      > .pane > *:not(editable-array):only-child,
      > .pane > editable-array > editable-array-item:only-child > * {
        height: 100%;
      }
    }

    .pane {
      min-width: 0;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
  }

  .split.half {
    --split-columns-desktop: 1fr 1fr;
  }

  .split.third-two-thirds {
    --split-columns-desktop: 1fr 2fr;
  }

  .split.two-thirds-third {
    --split-columns-desktop: 2fr 1fr;
  }

  .split.quarter-three-quarters {
    --split-columns-desktop: 1fr 3fr;
  }

  .split.three-quarters-quarter {
    --split-columns-desktop: 3fr 1fr;
  }

  .split.fixed-flexible {
    --split-columns-desktop: var(--split-fixed-width) 1fr;
  }

  .split.flexible-fixed {
    --split-columns-desktop: 1fr var(--split-fixed-width);
  }
</style>
