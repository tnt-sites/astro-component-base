---
const {
  number = 0,
  prefix,
  suffix,
  alignX = "start",
  size,
  class: className,
  _component,
  ...htmlAttributes
} = Astro.props;

const startNumber = Math.floor(number * 0.2);
const duration = 500;
---

<div
  class:list={["counter", `alignment-${alignX}`, size && `size-${size}`, className]}
  {...htmlAttributes}
>
  {prefix && <span class="prefix">{prefix}</span>}
  <span
    class="number"
    data-target={`${number}`}
    data-start={`${startNumber}`}
    data-duration={`${duration}`}
    aria-live="off">{number}</span
  >
  {suffix && <span class="suffix">{suffix}</span>}
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const counters = document.querySelectorAll(".counter > .number");
    if (!counters.length) return;

    const io = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            animateCounter(entry.target);
            io.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.6 }
    );

    counters.forEach((el) => io.observe(el));

    function animateCounter(el: Element) {
      const element = el as HTMLElement;
      if (element.dataset.hasRun) return;
      element.dataset.hasRun = "true";

      const start = parseFloat(element.dataset.start || "0");
      const target = parseFloat(element.dataset.target || "0");
      const duration = parseInt(element.dataset.duration || "2000", 10);

      let startTime: number | null = null;

      function step(ts: number) {
        if (!startTime) startTime = ts;
        const progress = Math.min((ts - startTime) / duration, 1);
        const value = start + (target - start) * progress;
        element.textContent = Math.floor(value).toLocaleString();
        if (progress < 1) requestAnimationFrame(step);
      }

      requestAnimationFrame(step);
    }
  });
</script>

<style lang="pcss" is:global>
  @layer components {
    .counter {
      align-items: start;
      display: flex;
      font-size: var(--font-size-heading-2xl);
      font-weight: var(--font-weight-bold);
      margin-top: var(--spacing-lg);

      &.alignment-end {
        justify-content: end;
      }
      &.alignment-center {
        justify-content: center;
      }

      &.size-xs {
        font-size: var(--font-size-heading-xs);
      }

      &.size-sm {
        font-size: var(--font-size-heading-sm);
      }

      &.size-md {
        font-size: var(--font-size-heading-md);
      }

      &.size-lg {
        font-size: var(--font-size-heading-lg);
      }

      &.size-xl {
        font-size: var(--font-size-heading-xl);
      }

      &.size-2xl {
        font-size: var(--font-size-heading-2xl);
      }

      &.size-3xl {
        font-size: var(--font-size-heading-3xl);
      }

      &.size-4xl {
        font-size: var(--font-size-heading-4xl);
      }

      .prefix,
      .suffix {
        white-space: pre-wrap;
      }
    }
  }
</style>
