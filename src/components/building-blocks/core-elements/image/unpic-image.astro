---
import { inferRemoteSize } from "astro:assets";
import { transformUrl } from "unpic";

const { source, alt, sizes, widths, width, height, priority, aspectRatio, ...htmlAttributes } =
  Astro.props;

const {
  "data-editable": dataEditable,
  "data-prop-src": dataPropSrc,
  "data-prop-alt": dataPropAlt,
  ...restHtmlAttributes
} = htmlAttributes;
const dataAttributes = dataEditable
  ? { "data-editable": dataEditable, "data-prop-src": dataPropSrc, "data-prop-alt": dataPropAlt }
  : {};

let imageWidth = width;
let imageHeight = height;

if (!imageWidth || !imageHeight) {
  try {
    const dimensions = await inferRemoteSize(source);

    if (dimensions && dimensions.width && dimensions.height) {
      imageWidth = imageWidth || dimensions.width;
      imageHeight = imageHeight || dimensions.height;
    }
  } catch (error) {
    console.warn(`Could not detect image dimensions for: ${source}`, error);
  }
}

let targetAspectRatio: number | null = null;
if (aspectRatio && aspectRatio !== "none") {
  const aspectRatioMap: Record<string, number> = {
    square: 1,
    landscape: 4 / 3,
    portrait: 3 / 4,
    widescreen: 16 / 9,
  };
  targetAspectRatio = aspectRatioMap[aspectRatio] || null;
}

const fallbackWidth = imageWidth || Math.min(...widths);
let calculatedAspectRatio: number;
let fallbackHeight: number;

if (targetAspectRatio) {
  calculatedAspectRatio = targetAspectRatio;
  fallbackHeight = Math.round(fallbackWidth / targetAspectRatio);
} else {
  calculatedAspectRatio = imageWidth && imageHeight ? imageHeight / imageWidth : 0.75;
  fallbackHeight = imageHeight || Math.round(fallbackWidth * calculatedAspectRatio);
}

const getTransformedUrl = (width: number, format: string) => {
  if (targetAspectRatio) {
    const cropHeight = Math.round(width / targetAspectRatio);
    return transformUrl({
      url: source,
      width,
      height: cropHeight,
      format,
    });
  } else {
    const height = Math.round(width * calculatedAspectRatio);
    return transformUrl({
      url: source,
      width,
      height,
      format,
    });
  }
};
---

<picture {...restHtmlAttributes}>
  <source
    type="image/avif"
    srcset={widths
      .map((width: number) => `${getTransformedUrl(width, "avif")} ${width}w`)
      .join(", ")}
    sizes={sizes}
  />
  <source
    type="image/webp"
    srcset={widths
      .map((width: number) => `${getTransformedUrl(width, "webp")} ${width}w`)
      .join(", ")}
    sizes={sizes}
  />
  <img
    {...dataAttributes}
    src={source}
    alt={alt || ""}
    loading={priority ? "eager" : "lazy"}
    decoding={priority ? "auto" : "async"}
    {...priority && { fetchpriority: "high" }}
    width={fallbackWidth}
    height={fallbackHeight}
    srcset={widths
      .map((width: number) => `${getTransformedUrl(width, "jpeg")} ${width}w`)
      .join(", ")}
    sizes={sizes}
  />
</picture>
