---
import clsx from "clsx";
import { getProviderForUrl } from "unpic";
import AstroImage from "./astro-image.astro";
import UnpicImage from "./unpic-image.astro";

const {
  src,
  alt,
  sizes = "(min-width: 30em) 50vw, 100vw",
  widths = [400, 600, 800, 1200, 1600],
  class: className,
  ...rest
} = Astro.props;

const htmlAttributes = Object.fromEntries(
  Object.entries(rest).filter(([key]) => !key.startsWith("_"))
);

const classNames = clsx("image", className);

const provider = getProviderForUrl(src);
const isExternalCDN = provider !== false;

const commonProps = {
  alt: alt || "",
  class: classNames,
  ...htmlAttributes,
};
---

{
  isExternalCDN ? (
    <UnpicImage {...commonProps} src={src} sizes={sizes} widths={widths} />
  ) : (
    <AstroImage {...commonProps} src={src} sizes={sizes} widths={widths} />
  )
}
