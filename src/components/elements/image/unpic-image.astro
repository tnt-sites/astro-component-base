---
import { transformUrl } from "unpic";

const { src, alt, class: className, sizes, widths, width, height, ...htmlAttributes } = Astro.props;

let imageWidth = width;
let imageHeight = height;

// Only try to probe image dimensions in Node.js environment
if (typeof process !== "undefined" && process.versions && process.versions.node) {
  try {
    // @ts-ignore - probe-image-size is only available in Node.js and may not be available in browser
    const probe = await import("probe-image-size");
    // @ts-ignore - probe-image-size types may not be available
    const dimensions = await probe.default(src);

    if (dimensions && dimensions.width && dimensions.height) {
      imageWidth = imageWidth || dimensions.width;
      imageHeight = imageHeight || dimensions.height;
      console.log(`Detected dimensions with probe-image-size: ${imageWidth}x${imageHeight}`);
    }
  } catch (error) {
    console.warn(`Could not detect image dimensions for: ${src}`, error);
  }
}

// Fallback dimensions if not provided or detected
const fallbackWidth = imageWidth || Math.min(...widths);
const fallbackHeight = imageHeight || Math.round(fallbackWidth * 0.75);
const aspectRatio = imageWidth && imageHeight ? imageHeight / imageWidth : 0.75;
---

<picture class:list={className} {...htmlAttributes}>
  <source
    type="image/avif"
    srcset={widths
      .map(
        (width: number) =>
          `${transformUrl({
            url: src,
            width,
            height: Math.round(width * aspectRatio),
            format: "avif",
          })} ${width}w`
      )
      .join(", ")}
    sizes={sizes}
  />
  <source
    type="image/webp"
    srcset={widths
      .map(
        (width: number) =>
          `${transformUrl({
            url: src,
            width,
            height: Math.round(width * aspectRatio),
            format: "webp",
          })} ${width}w`
      )
      .join(", ")}
    sizes={sizes}
  />
  <img
    src={src}
    alt={alt || ""}
    loading="lazy"
    decoding="async"
    width={fallbackWidth}
    height={fallbackHeight}
    srcset={widths
      .map(
        (width: number) =>
          `${transformUrl({
            url: src,
            width,
            height: Math.round(width * aspectRatio),
            format: "jpeg",
          })} ${width}w`
      )
      .join(", ")}
    sizes={sizes}
  />
</picture>
