---
import { getProviderForUrl } from "unpic";
import AstroImage from "./astro-image.astro";
import UnpicImage from "./unpic-image.astro";

const {
  src,
  alt,
  sizes = "(min-width: 30em) 50vw, 100vw",
  widths = [400, 600, 800, 1200, 1600],
  rounded = false,
  priority,
  class: className,
  ...rest
} = Astro.props;

const htmlAttributes = Object.fromEntries(
  Object.entries(rest).filter(([key]) => !key.startsWith("_"))
);

const provider = getProviderForUrl(src);
const isExternalCDN = provider !== false;

const commonProps = {
  alt: alt || "",
};
---

<div class:list={["smart-image", rounded && "rounded", className]} {...htmlAttributes}>
  {
    isExternalCDN ? (
      <UnpicImage {...commonProps} src={src} sizes={sizes} widths={widths} priority={priority} />
    ) : (
      <AstroImage {...commonProps} src={src} sizes={sizes} widths={widths} priority={priority} />
    )
  }
</div>
