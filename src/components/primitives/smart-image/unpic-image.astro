---
import { inferRemoteSize } from "astro:assets";
import { transformUrl } from "unpic";

const { src, alt, sizes, widths, width, height, priority, ...htmlAttributes } = Astro.props;

let imageWidth = width;
let imageHeight = height;

// Try to infer remote image dimensions using Astro's built-in function
if (!imageWidth || !imageHeight) {
  try {
    const dimensions = await inferRemoteSize(src);

    if (dimensions && dimensions.width && dimensions.height) {
      imageWidth = imageWidth || dimensions.width;
      imageHeight = imageHeight || dimensions.height;
    }
  } catch (error) {
    console.warn(`Could not detect image dimensions for: ${src}`, error);
    // Don't throw - just continue with fallback dimensions
  }
}

// Fallback dimensions if not provided or detected
const fallbackWidth = imageWidth || Math.min(...widths);
const fallbackHeight = imageHeight || Math.round(fallbackWidth * 0.75);
const aspectRatio = imageWidth && imageHeight ? imageHeight / imageWidth : 0.75;
---

<picture {...htmlAttributes}>
  <source
    type="image/avif"
    srcset={widths
      .map(
        (width: number) =>
          `${transformUrl({
            url: src,
            width,
            height: Math.round(width * aspectRatio),
            format: "avif",
          })} ${width}w`
      )
      .join(", ")}
    sizes={sizes}
  />
  <source
    type="image/webp"
    srcset={widths
      .map(
        (width: number) =>
          `${transformUrl({
            url: src,
            width,
            height: Math.round(width * aspectRatio),
            format: "webp",
          })} ${width}w`
      )
      .join(", ")}
    sizes={sizes}
  />
  <img
    src={src}
    alt={alt || ""}
    loading={priority ? "eager" : "lazy"}
    decoding={priority ? "auto" : "async"}
    {...priority && { fetchpriority: "high" }}
    width={fallbackWidth}
    height={fallbackHeight}
    srcset={widths
      .map(
        (width: number) =>
          `${transformUrl({
            url: src,
            width,
            height: Math.round(width * aspectRatio),
            format: "jpeg",
          })} ${width}w`
      )
      .join(", ")}
    sizes={sizes}
  />
</picture>
