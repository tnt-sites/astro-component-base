---
import navData from "@component-library/data/nav.json";
import Icon from "@components/elements/icon/icon.astro";
import NavItem from "@components/navigation/nav-item/nav-item.astro";
import NavList from "@components/navigation/nav-list/nav-list.astro";
import NavRoot from "@components/navigation/nav-root/nav-root.astro";
import { getCollection } from "astro:content";

const allComponents = await getCollection("docs-components");

const componentsByCategory: Record<
  string,
  Array<{ name: string; path: string; order: number }>
> = {};

allComponents.forEach((component: any) => {
  const slug = component.id.replace(/^components\//, "").replace(/\/index$/, "");
  const parts = slug.split("/").filter(Boolean);

  if (
    slug.includes("/examples/") ||
    slug.includes("bookshop") ||
    (!component.data.title && !component.data.name)
  ) {
    return;
  }

  if (parts.length >= 1) {
    const category = parts[0];
    const componentName = parts.length > 1 ? parts[1] : parts[0];

    if (!componentsByCategory[category]) {
      componentsByCategory[category] = [];
    }

    componentsByCategory[category].push({
      name: component.data.title || componentName.replace(/-/g, " "),
      path: `/component-library/components/${category}/${componentName}/`,
      order: Number(component.data.order) || 999,
    });
  }
});

// Populate nav.json structure with component collection data
const populatedNavData = navData.map((section) => {
  if (section.group) {
    const category = section.group.toLowerCase();
    const items = componentsByCategory[category] || [];

    const sortedItems = items.sort((a, b) => {
      if (a.order !== b.order) {
        return a.order - b.order;
      }

      return a.name.localeCompare(b.name);
    });

    // Check if any child item is the current page
    const currentPath = Astro.url.pathname;
    const hasActiveChild = sortedItems.some((item) => item.path === currentPath);

    return {
      ...section,
      items: sortedItems,
      defaultOpen: hasActiveChild,
    };
  }

  return section;
});
---

<div class="library-sidebar">
  <Icon name="library/logo" size="none" class="sidebar-logo" />
  <NavRoot variant="sidebar">
    <NavList>
      {
        populatedNavData
          .map((section, index) => {
            if (section.group && section.items && Array.isArray(section.items)) {
              return (
                <NavItem text={section.group} defaultOpen={(section as any).defaultOpen || false}>
                  <NavList>
                    {section.items.map((item, itemIndex) => {
                      return <NavItem href={item.path} text={item.name} />;
                    })}
                  </NavList>
                </NavItem>
              );
            }

            if (section.path) {
              return <NavItem href={section.path} text={section.name} />;
            }

            return null;
          })
          .filter(Boolean)
      }
    </NavList>
  </NavRoot>
</div>
