---
const { component_examples = [], title = "", size = "md", componentKey = "" } = Astro.props;

import { Code } from "astro:components";
import Button from "../../../components/elements/button/button.astro";
// @ts-ignore
import yaml from "js-yaml";

function getBodyPadding(spacing: string): string {
  switch (spacing) {
    case "all":
      return "padding: var(--spacing-md)";
    case "top":
      return "padding-top: var(--spacing-md)";
    case "sides":
      return "padding-left: var(--spacing-md); padding-right: var(--spacing-md);";
    default:
      return "";
  }
}

function formatBlocksYaml(blocks: any): string {
  if (!blocks) return "";

  try {
    return yaml.dump(blocks, {
      indent: 2,
      lineWidth: -1,
      noRefs: true,
      sortKeys: false,
    });
  } catch (error) {
    console.error("Error formatting YAML:", error);
    return "";
  }
}

// Load all components dynamically
const components: Record<string, Function> = {};
const componentImports = import.meta.glob("../../../components/**/*.astro", {
  eager: true,
});

Object.entries(componentImports).forEach(([path, obj]) => {
  const relativePath = path.replace("../../../components/", "").replace(/\.astro$/, "");
  const parts = relativePath.split("/");

  // Remove duplicate directory names (e.g., rich-text/rich-text -> rich-text)
  if (parts.length > 1 && parts[parts.length - 1] === parts[parts.length - 2]) {
    parts.pop();
  }

  const bookshopName = parts.join("/");

  components[bookshopName] = (obj as any).default;
});
---

<div class:list={["component-viewer", size && `viewer-size-${size}`]}>
  <div class="previews">
    {
      component_examples.map(async (example: any, idx: number) => {
        const bodyPadding = getBodyPadding(example.data.spacing);
        const exampleName = example.data.title;
        const exampleId = `component-${exampleName.toLowerCase().replace(/\s+/g, "-")}-${idx}`;

        const blocks = example.data.blocks || [];
        const blocksArray = Array.isArray(blocks) ? blocks : [blocks];

        return (
          <>
            <div id={exampleId} class:list={[`preview`, `${idx === 0 ? "active" : ""}`]}>
              <div class="examples" style={bodyPadding}>
                {blocksArray.map((block) => {
                  const Component = components[block._bookshop_name];

                  return Component ? <Component {...block} /> : null;
                })}
              </div>
            </div>

            <div class="code" id={`code-${exampleId}`}>
              <Code
                lang="yaml"
                code={formatBlocksYaml(example.data.blocks)}
                style="height: 100%; padding: var(--spacing-sm);"
              />
            </div>
          </>
        );
      })
    }
  </div>

  {
    component_examples.length > 0 && (
      <nav class="controls">
        <div>
          {component_examples.length > 1 && (
            <>
              <label for={`${title.toLowerCase().replace(/\s+/g, "-")}-examples`} class="sr-only">
                Examples:
              </label>
              <select class="select" id={`${title.toLowerCase().replace(/\s+/g, "-")}-examples`}>
                {component_examples.map((example: any, idx: number) => {
                  const exampleName = example.data.title;
                  const exampleId = `component-${exampleName.toLowerCase().replace(/\s+/g, "-")}-${idx}`;

                  return <option value={exampleId}>{exampleName}</option>;
                })}
              </select>
            </>
          )}
        </div>
        <div>
          <Button
            variant="ghost"
            label="View Code"
            size="lg"
            iconName="code-bracket"
            hideText={true}
            data-action="view-code"
          />
          <Button
            variant="ghost"
            label="View Component"
            size="lg"
            iconName="computer-desktop"
            hideText={true}
            data-action="view-component"
            class="hide"
          />
        </div>
      </nav>
    )
  }
</div>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const componentViewers = document.querySelectorAll(".component-viewer");

    componentViewers.forEach((viewer) => {
      const viewCodeBtn = viewer.querySelector('[data-action="view-code"]');
      const viewComponentBtn = viewer.querySelector('[data-action="view-component"]');
      const previews = viewer.querySelectorAll(".preview");
      const codeBlocks = viewer.querySelectorAll(".code");
      const exampleSelect = viewer.querySelector("select");

      const switchToExample = (exampleId) => {
        previews.forEach((preview) => {
          preview.classList.remove("active");
        });

        const selectedPreview = viewer.querySelector(`#${exampleId}`);

        if (selectedPreview) {
          selectedPreview.classList.add("active");
        }

        const isCodeView = viewComponentBtn && !viewComponentBtn.classList.contains("hide");

        if (isCodeView) {
          previews.forEach((preview) => {
            preview.style.display = "none";
          });

          codeBlocks.forEach((codeBlock) => {
            const codeBlockId = codeBlock.id;

            if (codeBlockId === `code-${exampleId}`) {
              codeBlock.style.display = "block";
            } else {
              codeBlock.style.display = "none";
            }
          });
        } else {
          previews.forEach((preview) => {
            if (preview.classList.contains("active")) {
              preview.style.display = "block";
            } else {
              preview.style.display = "none";
            }
          });
          codeBlocks.forEach((codeBlock) => {
            codeBlock.style.display = "none";
          });
        }
      };

      if (exampleSelect) {
        const activePreview = viewer.querySelector(".preview.active");

        if (activePreview) {
          const activeId = activePreview.id;

          if (exampleSelect.value !== activeId) {
            exampleSelect.value = activeId;
          }
        }
      }

      if (exampleSelect) {
        exampleSelect.addEventListener("change", (event) => {
          const selectedValue = event.target.value;

          switchToExample(selectedValue);
        });
      }

      if (viewCodeBtn && viewComponentBtn) {
        viewCodeBtn.addEventListener("click", () => {
          viewCodeBtn.classList.add("hide");
          viewComponentBtn.classList.remove("hide");

          const activePreview = viewer.querySelector(".preview.active");

          if (activePreview) {
            const activeId = activePreview.id;

            switchToExample(activeId);
          }
        });

        viewComponentBtn.addEventListener("click", () => {
          viewCodeBtn.classList.remove("hide");
          viewComponentBtn.classList.add("hide");

          const activePreview = viewer.querySelector(".preview.active");

          if (activePreview) {
            const activeId = activePreview.id;

            switchToExample(activeId);
          }
        });
      }
    });
  });
</script>

<style>
  .component-viewer {
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-xs);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    overflow: hidden;
  }

  .hide {
    display: none;
  }

  .previews {
    height: 100%;
    overflow-y: auto;
  }

  .preview {
    display: none;
    min-height: 100%;
  }

  .preview.active {
    display: block;
    overflow-y: auto;
  }

  .code {
    display: none;
    height: 100%;
  }

  .viewer-size {
    &-sm {
      height: 10rem;
    }

    &-md {
      height: 20rem;
    }

    &-lg {
      height: 30rem;
    }
  }

  .controls {
    align-items: center;
    background: var(--color-bg-surface);
    border-top: 1px solid var(--color-border-subtle);
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-sm);

    > * {
      line-height: 0;
    }
  }
</style>
