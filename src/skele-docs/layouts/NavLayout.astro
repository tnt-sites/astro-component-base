---
import { getCollection } from "astro:content";
import NavItem from "../../components/navigation/nav-item/nav-item.astro";
import NavList from "../../components/navigation/nav-list/nav-list.astro";
import NavRoot from "../../components/navigation/nav-root/nav-root.astro";
import navData from "../data/nav.json";

const variant = "sidebar";

const allComponents = await getCollection("docs-components");

const componentsByCategory: Record<string, Array<{ name: string; path: string }>> = {};

allComponents.forEach((component: any) => {
  const slug = component.id.replace(/^components\//, "").replace(/\/index$/, "");
  const parts = slug.split("/").filter(Boolean);

  if (
    slug.includes("/examples/") ||
    slug.includes("bookshop") ||
    (!component.data.title && !component.data.name)
  ) {
    return;
  }

  if (parts.length >= 1) {
    const category = parts[0];
    const componentName = parts.length > 1 ? parts[1] : parts[0];

    if (!componentsByCategory[category]) {
      componentsByCategory[category] = [];
    }

    componentsByCategory[category].push({
      name: component.data.title || componentName.replace(/-/g, " "),
      path: `/skele/components/${category}/${componentName}/`,
    });
  }
});

// Populate nav.json structure with component collection data
const populatedNavData = navData.map((section) => {
  if (section.group) {
    const category = section.group.toLowerCase();
    const items = componentsByCategory[category] || [];

    const sortedItems = items.sort((a, b) => a.name.localeCompare(b.name));

    // Check if any child item is the current page
    const currentPath = Astro.url.pathname;
    const hasActiveChild = sortedItems.some((item) => item.path === currentPath);

    return {
      ...section,
      items: sortedItems,
      defaultOpen: hasActiveChild,
    };
  }

  return section;
});
---

<NavRoot variant={variant}>
  <img
    src="/assets/images/skele-light.svg"
    alt="Logo"
    height="32"
    width="110"
    style=" margin-inline-start: var(--spacing-lg);margin-bottom: var(--spacing-md);"
  />
  <NavList>
    {
      populatedNavData
        .map((section, index) => {
          try {
            if (section.group && section.items && Array.isArray(section.items)) {
              return (
                <NavItem label={section.group} defaultOpen={(section as any).defaultOpen || false}>
                  <NavList>
                    {section.items.map((item, itemIndex) => {
                      try {
                        return <NavItem href={item.path} label={item.name} />;
                      } catch (itemError) {
                        console.error(`Error rendering navigation item ${itemIndex}:`, itemError);
                        return null;
                      }
                    })}
                  </NavList>
                </NavItem>
              );
            }

            if (section.path) {
              return <NavItem href={section.path} label={section.name} />;
            }

            return null;
          } catch (sectionError) {
            console.error(`Error rendering navigation section ${index}:`, sectionError);
            return null;
          }
        })
        .filter(Boolean)
    }
  </NavList>
</NavRoot>
