---
import Heading from "@core-elements/heading/Heading.astro";
import Image from "@core-elements/image/Image.astro";
import SimpleText from "@core-elements/simple-text/SimpleText.astro";
import Page from "@layouts/Page.astro";
import CustomSection from "@page-sections/builders/custom-section/CustomSection.astro";
import { getCollection, render, type CollectionEntry } from "astro:content";

// Automatically import all components from building-blocks and page-sections for MDX
const buildingBlocksImports = import.meta.glob("../../components/building-blocks/**/*.astro", {
  eager: true,
});

const pageSectionsImports = import.meta.glob("../../components/page-sections/**/*.astro", {
  eager: true,
});

// Merge both import objects
const componentImports = { ...buildingBlocksImports, ...pageSectionsImports };

// Build components object with PascalCase names from file paths
const mdxComponents: Record<string, any> = {};

Object.entries(componentImports).forEach(([path, module]) => {
  const pathParts = path.split("/");
  const fileName = pathParts[pathParts.length - 1].replace(".astro", "");
  const folderName = pathParts[pathParts.length - 2];

  // Convert PascalCase to component name (already PascalCase, so just use it)
  // If filename matches folder (in kebab-case), use folder-based name
  const kebabFileName = fileName
    .replace(/([A-Z])/g, "-$1")
    .toLowerCase()
    .replace(/^-/, "");
  const kebabFolderName = folderName
    .replace(/([A-Z])/g, "-$1")
    .toLowerCase()
    .replace(/^-/, "");

  // Component name is already PascalCase from filename
  const componentName = fileName;

  mdxComponents[componentName] = (module as any).default;
});

export async function getStaticPaths() {
  const posts = await getCollection("blog");

  return posts.map((post: CollectionEntry<"blog">) => {
    const slug = post.id?.replace(/\.mdx?$/, "") || post.slug;

    return {
      params: { slug },
      props: { post },
    };
  });
}

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const { Content } = await render(post);
const date = post.data.date.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});
---

<Page title={post.data.title} description={post.data.description} image={post.data.image.source}>
  <CustomSection
    maxContentWidth="xl"
    paddingHorizontal="lg"
    paddingVertical="4xl"
    colorScheme="default"
    backgroundColor="base"
    class="post-container"
  >

    <Heading level="h1" size="3xl" alignX="center" style="margin-bottom: var(--spacing-xs); text-transform: uppercase;">
      {post.data.title}
    </Heading>
    <div class="post">
      <SimpleText size="md">
        {date}
      </SimpleText>
  
      {
        post.data.image && (
          <Image
            source={post.data.image.source}
            alt={post.data.image.alt}
            rounded={false}
            editable={false}
            class="post-image"
            aspectRatio="landscape"
            positionVertical="center"
            
          />
        )
      }

      <Content components={mdxComponents} />
    </div>
  </CustomSection>
</Page>

<style>
  :global(.post-container.custom-section) > :global(.outer-content) > :global(.content) {
    margin: 20px auto;
    padding: 20px;
    background-color: #ffffff;
    border: 1px solid #dddddd;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    text-align: left;
    position: relative;
  }
  .post {
    font-size: var(--font-size-md);
  }

  .post > :global(h1),
  .post > :global(h2),
  .post > :global(h3),
  .post > :global(h4),
  .post > :global(h5),
  .post > :global(h6) {
    margin-bottom: 0;
    margin-top: 1rem;
  }

  .post > :global(h1:first-child),
  .post > :global(h2:first-child),
  .post > :global(h3:first-child),
  .post > :global(h4:first-child),
  .post > :global(h5:first-child),
  .post > :global(h6:first-child) {
    margin-top: 0;
  }

  .post :global(a) {
    color: var(--color-brand);
    text-decoration: none;
    &:hover {
      color: var(--color-brand-muted);
      text-decoration: none;
    }
  }

  .post > :global(.astro-code) {
    margin-block: var(--spacing-xl);
  }

  .post-image {
    float: right;
    margin: .5em 0 .5em 1em;
    max-width: 300px;
  }
</style>
