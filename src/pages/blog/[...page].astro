---
import Components from "@components/utils/renderBlock.astro";
import Heading from "@core-elements/heading/Heading.astro";
import Image from "@core-elements/image/Image.astro";
import Pagination from "@core-elements/pagination/Pagination.astro";
import SimpleText from "@core-elements/simple-text/SimpleText.astro";
import Page from "@layouts/Page.astro";
import CustomSection from "@page-sections/builders/custom-section/CustomSection.astro";
import Card from "@wrappers/card/Card.astro";
import Grid from "@wrappers/grid/Grid.astro";
import GridItem from "@wrappers/grid/GridItem.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths({ paginate }) {
  const blogPosts = (await getCollection("blog")).sort(
    (a: any, b: any) => b.data.date.getTime() - a.data.date.getTime()
  );

  return paginate(blogPosts, { pageSize: 9 });
}

const { page } = Astro.props;

// Try to load blog page from pages collection for hero sections
let blogPage: any;
let heroSections: any[] = [];

try {
  const pages = await getCollection("pages");

  blogPage = pages.find((page: any) => page.id === "blog");

  if (blogPage?.data?.pageSections) {
    heroSections = blogPage.data.pageSections;
  }
} catch {}

const pageTitle = blogPage?.data?.title ?? "Blog";
const pageDescription =
  blogPage?.data?.description ??
  "Read our latest articles and insights on web development, design, and technology.";
---

<Page title={pageTitle} description={pageDescription}>
  {heroSections.length > 0 && <Components contentSections={heroSections} propName="pageSections" />}

  <CustomSection
    maxContentWidth="2xl"
    paddingHorizontal="lg"
    paddingVertical="none"
    colorScheme="default"
    backgroundColor="base"
  >
    {
      page.data.length > 0 ? (
        <>
          <Grid
            gap="lg"
            layout="start"
            minItemWidth="320"
            maxItemWidth="400"
            style="margin-top: var(--spacing-2xl)"
            editable={false}
          >
            {page.data.map((post: any) => {
              const pubDate = post.data.date.toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              });

              // Get slug from id (for glob loader) or slug property (for default loader)
              const slug = post.id?.replace(/\.mdx?$/, "") || post.slug;

              return (
                <GridItem editable={false}>
                  <Card
                    link={`/blog/${slug}`}
                    rounded={true}
                    border={true}
                    paddingVertical="lg"
                    paddingHorizontal="lg"
                    editable={false}
                  >
                    {post.data.image && (
                      <Image
                        slot="before"
                        source={post.data.image}
                        alt={post.data.title}
                        aspectRatio="landscape"
                        editable={false}
                      />
                    )}
                    <SimpleText
                      size="sm"
                      style="color: var(--color-text-muted); margin-bottom: var(--spacing-xs);"
                      editable={false}
                    >
                      {pubDate} â€¢ {post.data.author || "Anonymous"}
                    </SimpleText>
                    <Heading
                      level="h3"
                      size="md"
                      style="margin-bottom: var(--spacing-md); margin-top: var(--spacing-sm);"
                      editable={false}
                    >
                      {post.data.title}
                    </Heading>
                    <SimpleText
                      size="sm"
                      style="color: var(--color-text-muted); margin-top: 0;"
                      editable={false}
                    >
                      {post.data.description}
                    </SimpleText>
                  </Card>
                </GridItem>
              );
            })}
          </Grid>
          <Pagination page={page} showArrows={true} style="margin-top: var(--spacing-2xl);" />
        </>
      ) : (
        <SimpleText alignX="center" style="margin-top: var(--spacing-2xl);" editable={false}>
          No blog posts yet. Check back soon!
        </SimpleText>
      )
    }
  </CustomSection>
</Page>
