---
import ComponentLayout from "@component-library/layouts/ComponentLayout.astro";
import { getCollection, render } from "astro:content";
// @ts-ignore
import { existsSync, readFileSync } from "fs";
import yaml from "js-yaml";

export async function getStaticPaths() {
  const schemaFiles = import.meta.glob("../../../components/**/schema.ts", {
    eager: true,
  });

  try {
    const components = await getCollection("docs-components");

    if (!components || components.length === 0) {
      return [];
    }

    const componentEntries = components.filter((entry) => {
      return entry && entry.id && !entry.id.includes("/examples/");
    });

    return componentEntries.map((entry) => {
      const slug = entry.id.replace(/^components\//, "").replace(/\/index$/, "");
      const parts = slug.split("/").filter(Boolean);
      const componentKey = parts.join("/");

      let schema = null;
      let bookshopData = null;

      const camelCaseKey = componentKey
        .split("-")
        .map((part, index) => {
          if (index === 0) {
            return part.charAt(0).toUpperCase() + part.slice(1);
          }
          return part.charAt(0).toUpperCase() + part.slice(1);
        })
        .join("");

      for (const [path, mod] of Object.entries(schemaFiles)) {
        if (path.toLowerCase().includes(`/${camelCaseKey.toLowerCase()}/`)) {
          const module = mod as { [key: string]: { meta?: () => { description?: string } } };
          const schemaName = Object.keys(module).find((key) => key.endsWith("Schema"));

          if (schemaName) {
            schema = module[schemaName];
          }
          break;
        }
      }

      const lastPart = componentKey.split("/").pop();
      const bookshopPath = `src/components/${componentKey}/${lastPart}.bookshop.yml`;

      if (existsSync(bookshopPath)) {
        try {
          const content = readFileSync(bookshopPath, "utf8");

          bookshopData = yaml.load(content);
        } catch (error) {
          console.error(`Error parsing bookshop file ${bookshopPath}:`, error);
        }
      }

      return {
        params: { slug: componentKey },
        props: { page: entry, schema, bookshopData },
      };
    });
  } catch (error) {
    console.error("Error loading docs-components collection:", error);
    return [];
  }
}

const { page, schema, bookshopData } = Astro.props;
const { Content } = await render(page);
const frontmatter = page.data;

const slugParts = page.id
  .replace(/^components\//, "")
  .replace(/\/index$/, "")
  .split("/")
  .filter(Boolean);

const componentKey = slugParts.join("/");

const searchPattern = `${componentKey}/examples/`.toLowerCase();

let examples = [];

try {
  examples = await getCollection("docs-components", ({ id }) => {
    return id && id.toLowerCase().startsWith(searchPattern);
  });
} catch (error) {
  console.error("Error loading examples:", error);
}
---

<ComponentLayout
  frontmatter={frontmatter}
  schema={schema}
  bookshopData={bookshopData}
  examples={examples}
  componentKey={componentKey}
>
  <Content />
</ComponentLayout>
